{% extends 'base.html' %}
{% load static %}

{% block title %}ثبت نام - HeyVoonak{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #3EA66B;
        --primary-dark: #2d8a54;
        --secondary: #4B6A9D;
        --bg: #f0f9ff;
        --card: #ffffff;
        --text: #1e293b;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --radius: 20px;
        --shadow: 0 25px 50px rgba(0, 0, 0, 0.09);
    }

    body {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .auth-container {
        width: 100%;
        max-width: 480px;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        animation: fadeInUp 0.7s ease-out;
        margin: 2rem auto;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(40px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .auth-header {
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        padding: 3rem 2rem 2.5rem;
        text-align: center;
        color: white;
    }

    .logo-icon {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .logo-icon i {
        font-size: 2.3rem;
    }

    .logo-text {
        font-size: 1.9rem;
        font-weight: 800;
        margin-bottom: 0.4rem;
    }

    .logo-subtitle {
        font-size: 1rem;
        opacity: 0.95;
    }

    .auth-form {
        padding: 2rem;
    }

    .form-group {
        margin-bottom: 1.6rem;
    }

    .form-label {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
        display: block;
    }

    .input-group {
        position: relative;
    }

    .form-input {
        width: 100%;
        padding: 1rem 3.5rem 1rem 1rem;
        border: 2px solid var(--border);
        border-radius: 14px;
        font-size: 1rem;
        background: #fff;
        transition: all 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 5px rgba(62, 166, 107, 0.15);
    }

    .password-toggle {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.4rem;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .password-toggle:hover {
        color: var(--primary);
        background: rgba(62, 166, 107, 0.1);
    }

    .input-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1.15rem;
        pointer-events: none;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.2rem;
    }

    .checkbox-label {
        font-size: 0.92rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .checkbox-label a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
    }

    .checkbox-label a:hover {
        text-decoration: underline;
    }

    .submit-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        color: white;
        border: none;
        padding: 1.1rem;
        border-radius: 14px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 1rem;
    }

    .submit-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(62, 166, 107, 0.35);
    }

    .submit-btn.loading {
        opacity: 0.8;
        position: relative;
        color: transparent;
    }

    .submit-btn.loading::after {
        content: '';
        position: absolute;
        width: 26px;
        height: 26px;
        border: 3px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        to {
            transform: translate(-50%, -50%) rotate(360deg);
        }
    }

    .auth-footer {
        text-align: center;
        padding: 1.5rem;
        color: var(--text-muted);
        font-size: 0.95rem;
    }

    .auth-footer a {
        color: var(--primary);
        font-weight: 600;
        text-decoration: none;
    }

    .password-strength {
        margin-top: 0.6rem;
    }

    .strength-bar {
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
    }

    .strength-fill {
        height: 100%;
        width: 0;
        transition: width 0.4s;
        border-radius: 3px;
    }

    .strength-fill.weak {
        width: 25%;
        background: #ef4444;
    }

    .strength-fill.fair {
        width: 50%;
        background: #f59e0b;
    }

    .strength-fill.good {
        width: 75%;
        background: #3b82f6;
    }

    .strength-fill.strong {
        width: 100%;
        background: var(--primary);
    }

    .strength-text {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 0.4rem;
    }

    .error-message,
    .success-message {
        padding: 0.9rem 1.2rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        font-size: 0.92rem;
        display: none;
        align-items: center;
        gap: 0.5rem;
    }

    .error-message {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .success-message {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .validation-message {
        font-size: 0.85rem;
        margin-top: 0.5rem;
        padding: 0.6rem;
        border-radius: 8px;
        display: none;
        border-left: 4px solid;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        animation: fadeIn 0.3s;
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        border-radius: var(--radius);
        width: 90%;
        max-width: 700px;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: var(--shadow);
        animation: slideDown 0.4s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, var(--secondary), var(--primary));
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.6rem;
        cursor: pointer;
        transition: 0.3s;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 2rem;
        overflow-y: auto;
        max-height: 60vh;
        line-height: 1.8;
        color: #444;
    }

    .modal-body h3 {
        color: var(--primary);
        margin: 1.8rem 0 1rem;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-body ul {
        padding-right: 2rem;
        margin: 1rem 0;
    }

    .modal-body li {
        margin-bottom: 0.7rem;
    }

    @media (max-width:480px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .auth-header {
            padding: 2.5rem 1.5rem 2rem;
        }

        .auth-form {
            padding: 1.8rem 1.5rem;
        }

        .modal-content {
            width: 95%;
            margin: 8% auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-header">
        <div class="logo-icon"><i class="fas fa-user-plus"></i></div>
        <div class="logo-text">ثبت نام</div>
        <div class="logo-subtitle">حساب کاربری جدید ایجاد کنید</div>
    </div>

    <div class="auth-form">
        <div class="error-message" id="errorMessage"><i class="fas fa-exclamation-circle"></i> <span
                id="errorText"></span></div>
        <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i> <span
                id="successText"></span></div>

        <form id="registerForm" method="post">
            {% csrf_token %}

            {% if messages %}
            {% for message in messages %}
            <div class="error-message" style="display:flex"><i class="fas fa-exclamation-circle"></i> {{ message }}
            </div>
            {% endfor %}
            {% endif %}

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="first_name">نام</label>
                    <div class="input-group">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="first_name" name="first_name" class="form-input" placeholder="نام"
                            value="{{ first_name|default:'' }}" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="last_name">نام خانوادگی</label>
                    <div class="input-group">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="last_name" name="last_name" class="form-input" placeholder="نام خانوادگی"
                            value="{{ last_name|default:'' }}" required>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="phone_number">شماره تلفن</label>
                <div class="input-group">
                    <i class="fas fa-phone input-icon"></i>
                    <input type="tel" id="phone_number" name="phone_number" class="form-input" placeholder="09123456789"
                        value="{{ phone_number|default:'' }}" required>
                </div>
                <div class="validation-message" id="phoneMessage"></div>
            </div>

            <div class="form-group">
                <label class="form-label" for="username">نام کاربری</label>
                <div class="input-group">
                    <i class="fas fa-at input-icon"></i>
                    <input type="text" id="username" name="username" class="form-input" placeholder="نام کاربری دلخواه"
                        value="{{ username|default:'' }}" required>
                </div>
                <div class="validation-message" id="usernameMessage"></div>
            </div>

            <div class="form-group">
                <label class="form-label" for="password">رمز عبور</label>
                <div class="input-group">
                    <button type="button" class="password-toggle" onclick="togglePassword('password')">
                        <i class="fas fa-eye" id="passwordToggleIcon"></i>
                    </button>
                    <input type="password" id="password" name="password" class="form-input" placeholder="رمز عبور قوی"
                        required>
                </div>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <div class="strength-text" id="strengthText">رمز عبور خود را وارد کنید</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="confirm_password">تکرار رمز عبور</label>
                <div class="input-group">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirm_password')">
                        <i class="fas fa-eye" id="confirmPasswordToggleIcon"></i>
                    </button>
                    <input type="password" id="confirm_password" name="confirm_password" class="form-input"
                        placeholder="تکرار رمز عبور" required>
                </div>
            </div>

            <div style="margin:2rem 0;">
                <label class="checkbox-label">
                    <input type="checkbox" id="terms" name="terms" required
                        style="width:18px;height:18px;cursor:pointer;">
                    با <a href="#" id="termsLink">شرایط و قوانین</a> و <a href="#" id="privacyLink">حریم خصوصی</a>
                    موافقم
                </label>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                <i class="fas fa-user-plus"></i> ایجاد حساب کاربری
            </button>
        </form>
    </div>

    <div class="auth-footer">
        قبلاً حساب دارید؟ <a href="/login/">وارد شوید</a>
    </div>
</div>

<!-- مودال شرایط و قوانین -->
<div id="termsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>شرایط و قوانین استفاده</h2>
            <button class="modal-close" onclick="closeModal('termsModal')">×</button>
        </div>
        <div class="modal-body">
            <h3>پذیرش قوانین</h3>
            <p>با ثبت‌نام در این پلتفرم، شما تمامی شرایط و قوانین زیر را می‌پذیرید و متعهد می‌شوید که به آنها پایبند
                باشید.</p>
            <h3>حساب کاربری</h3>
            <ul>
                <li>اطلاعات وارد شده باید صحیح و واقعی باشد</li>
                <li>حفظ امنیت رمز عبور به عهده شما است</li>
                <li>استفاده از حساب توسط اشخاص ثالث ممنوع است</li>
                <li>در صورت سوءاستفاده، حساب مسدود خواهد شد</li>
            </ul>
            <h3>استفاده از محتوا</h3>
            <ul>
                <li>محتوای آموزشی فقط برای مقاصد علمی است</li>
                <li>کپی‌برداری و انتشار محتوا ممنوع است</li>
                <li>پلتفرم جایگزین مشاوره پزشکی نیست</li>
            </ul>
            <h3>پرداخت و اشتراک</h3>
            <ul>
                <li>استفاده از برخی امکانات نیازمند اشتراک است</li>
                <li>استرداد وجه طبق قوانین انجام می‌شود</li>
            </ul>
            <p style="margin-top:2rem; color:#666;">آخرین به‌روزرسانی: آبان ۱۴۰۴</p>
        </div>
    </div>
</div>

<!-- مودال حریم خصوصی -->
<div id="privacyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>سیاست حریم خصوصی</h2>
            <button class="modal-close" onclick="closeModal('privacyModal')">×</button>
        </div>
        <div class="modal-body">
            <h3>جمع‌آوری اطلاعات</h3>
            <p>ما فقط اطلاعات ضروری را جمع‌آوری می‌کنیم:</p>
            <ul>
                <li>نام، نام خانوادگی، شماره تلفن</li>
                <li>نام کاربری و رمز عبور (رمزنگاری شده)</li>
                <li>اطلاعات فنی برای امنیت</li>
            </ul>
            <h3>حفاظت از اطلاعات</h3>
            <ul>
                <li>رمزنگاری پیشرفته</li>
                <li>پروتکل HTTPS/SSL</li>
                <li>محدودیت دسترسی</li>
            </ul>
            <h3>حقوق شما</h3>
            <ul>
                <li>دسترسی، اصلاح و حذف اطلاعات</li>
                <li>انصراف از دریافت ایمیل</li>
            </ul>
            <p style="margin-top:2rem; color:#666;">آخرین به‌روزرسانی: آبان ۱۴۰۴</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function togglePassword(id) {
        const input = document.getElementById(id);
        const icon = document.getElementById(id + 'ToggleIcon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    document.getElementById('password').addEventListener('input', function () {
        const pw = this.value;
        const fill = document.getElementById('strengthFill');
        const text = document.getElementById('strengthText');
        let score = 0;
        if (pw.length >= 8) score++;
        if (/[a-z]/.test(pw)) score++;
        if (/[A-Z]/.test(pw)) score++;
        if (/[0-9]/.test(pw)) score++;
        if (/[^A-Za-z0-9]/.test(pw)) score++;

        fill.className = 'strength-fill';
        if (score <= 1) fill.classList.add('weak');
        else if (score <= 2) fill.classList.add('fair');
        else if (score <= 3) fill.classList.add('good');
        else fill.classList.add('strong');

        const labels = ['رمز عبور خود را وارد کنید', 'ضعیف', 'متوسط', 'خوب', 'قوی'];
        text.textContent = pw ? `قدرت رمز: ${labels[score] || 'قوی'}` : labels[0];
    });

    document.getElementById('registerForm').addEventListener('submit', function (e) {
        const p1 = document.getElementById('password').value;
        const p2 = document.getElementById('confirm_password').value;
        if (p1 !== p2) {
            e.preventDefault();
            document.getElementById('errorText').textContent = 'رمزهای عبور مطابقت ندارند';
            document.getElementById('errorMessage').style.display = 'flex';
            return;
        }
        document.getElementById('submitBtn').classList.add('loading');
    });

    function openModal(id) {
        document.getElementById(id).style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    document.getElementById('termsLink').addEventListener('click', e => { e.preventDefault(); openModal('termsModal'); });
    document.getElementById('privacyLink').addEventListener('click', e => { e.preventDefault(); openModal('privacyModal'); });
    window.addEventListener('click', e => {
        if (e.target.classList.contains('modal')) closeModal(e.target.id);
    });
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(m => m.style.display === 'block' && closeModal(m.id));
        }
    });

    let usernameTimeout, phoneTimeout;

    const usernameInput = document.getElementById('username');
    const phoneInput = document.getElementById('phone_number');
    const usernameMessage = document.getElementById('usernameMessage');
    const phoneMessage = document.getElementById('phoneMessage');

    usernameInput.addEventListener('input', function () {
        clearTimeout(usernameTimeout);
        const val = this.value.trim();
        if (!val) { usernameMessage.style.display = 'none'; return; }
        usernameTimeout = setTimeout(async () => {
            try {
                const res = await fetch('/api/check-username/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: val }) });
                const data = await res.json();
                usernameMessage.innerHTML = data.available
                    ? `<i class="fas fa-check-circle"></i> ${data.message || 'در دسترس'}`
                    : `<i class="fas fa-times-circle"></i> ${data.message}`;
                usernameMessage.style.display = 'block';
                usernameMessage.style.backgroundColor = data.available ? '#d4edda' : '#f8d7da';
                usernameMessage.style.color = data.available ? '#155724' : '#721c24';
                usernameMessage.style.borderLeftColor = data.available ? '#28a745' : '#dc3545';
            } catch (e) { console.error(e); }
        }, 600);
    });

    phoneInput.addEventListener('input', function () {
        clearTimeout(phoneTimeout);
        const val = this.value.trim();
        if (!val) { phoneMessage.style.display = 'none'; return; }
        phoneTimeout = setTimeout(async () => {
            try {
                const res = await fetch('/api/check-phone/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: val }) });
                const data = await res.json();
                phoneMessage.innerHTML = data.available
                    ? `<i class="fas fa-check-circle"></i> ${data.message || 'در دسترس'}`
                    : `<i class="fas fa-times-circle"></i> ${data.message}`;
                phoneMessage.style.display = 'block';
                phoneMessage.style.backgroundColor = data.available ? '#d4edda' : '#f8d7da';
                phoneMessage.style.color = data.available ? '#155724' : '#721c24';
                phoneMessage.style.borderLeftColor = data.available ? '#28a745' : '#dc3545';
            } catch (e) { console.error(e); }
        }, 600);
    });
</script>
{% endblock %}